name: Generate Master Plan

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  build-plan:
    outputs:
      has_changes: ${{ steps.diff.outputs.has_changes }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Collect changed config files
        id: diff
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
          else
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
              base="$(git rev-list --max-parents=0 "$head")"
            fi
          fi

          echo "Comparing $base...$head"
          mapfile -t files < <(git diff --name-only --diff-filter=ACDMR "$base" "$head" -- configs/changedfiles || true)

          if [ ${#files[@]} -eq 0 ]; then
            echo "No changed files under configs/changedfiles"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          stripped=()
          for f in "${files[@]}"; do
            stripped+=("${f#configs/}")
          done

          joined="${stripped[*]}"
          echo "CHANGEDFILES=$joined" >> "$GITHUB_ENV"
          echo "files=$joined" >> "$GITHUB_OUTPUT"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Download plan generator jar
        if: steps.diff.outputs.has_changes == 'true'
        run: |
          curl -fL --retry 3 -o cac-ex.jar https://github.com/srinuneehaal/CaC-Patterns/releases/latest/download/cac-ex-0.0.1-SNAPSHOT.jar

      - name: Generate masterplan.json
        if: steps.diff.outputs.has_changes == 'true'
        working-directory: configs
        env:
          CHANGEDFILES: ${{ steps.diff.outputs.files }}
        run: |
          java -jar ../cac-ex.jar

      - name: Upload master plan artifact
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: masterplan
          path: configs/plan/masterplan.json

  approval:
    needs: build-plan
    if: needs.build-plan.outputs.has_changes == 'true'
    outputs:
      has_changes: ${{ needs.build-plan.outputs.has_changes }}
    runs-on: ubuntu-latest
    environment: apply-plan-approval
    steps:
      - name: Await approval to apply master plan
        run: echo "Approval required via environment protection to proceed with apply-plan job."

  apply-plan:
    needs:
      - approval
    if: needs.approval.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Download master plan artifact
        uses: actions/download-artifact@v4
        with:
          name: masterplan
          path: masterplan

      - name: Download plan generator jar
        run: |
          curl -fL --retry 3 -o cac-ex.jar https://github.com/srinuneehaal/CaC-Patterns/releases/latest/download/cac-ex-0.0.1-SNAPSHOT.jar

      - name: Apply master plan
        working-directory: configs
        run: |
          java -jar ../cac-ex.jar --apply ../masterplan/masterplan.json
